# 채팅 기능에 사용할 기술 선택

## 구현 준비

이번에 진행할 기능은 채팅 기능이다. SSE를 진행할 때 웹소켓, Polling, Long Polling 방식을 알아봐서 웹소켓 방식으로 하겠구나 인지하고 있었다.

우선 채팅 기능을 구현하기 위해 관련 레퍼런스들을 찾아보고 어떻게 시스템을 구현하고, 구성하는지 알아봤다. 지나가는 키워드들 중 **Kafka, Stomp, MogoDB, WebSocket** 이 많이 나왔는데, 중요한건 이중에서 한번도 써본 것이 없다는 것이다. 

일단 큰 프로젝트가 이니기 때문에 WebSocket과 Stomp를 비교하여 그 중 프로젝트에 맞는 기술을 채택하기로 결정했다.

## WebSocket vs Stomp

### WebSocket

웹 소켓은 HTML5 표준 기술로, HTTP 환경에서 클라이언트와 서버 사이에 **하나의 TCP 연결을 통해 실시간으로 전이중 통신을 가능**하게 하는 프로토콜이다.

웹 소켓이 개발되기 이전에는 Polling이나 Long Polling 방식으로 실시간은 아니지만 비슷하게 구현해서 문제를 해결해왔다고 한다.

Polling이나 Long Polling에 대해서는 SSE를 구현할 때 다뤘기 때문에 궁금하면 해당 링크에서 확인하면 된다.

[알림 기능의 통신 방법 고민](../알림기능/통신방법.md)

웹 소켓이 등장한 이후부터는 클라이언트와 서버간의 실시간 통신이 가능하게 되었다.

HTTP 통신에서는 연결을 지속하지 않고, 클라이언트가 서버로 단방향 요청만 가능하게 구성되어 있었다.

웹 소켓이 등장한 이후부터는 클라이언트와 서버간 연결을 지속적으로 유지하고 서버도 클라이언트로 클라이언트도 서버로 데이터를 보낼 수 있게 됨으로서 **양방향 통신**을 할 수 있게 되었다.

참고로 웹 소켓은 요청과 응답 개념이 아닌 서로 데이터를 주고 받는 형식을 취하고 있다.

그러면 웹 소켓만으로는 채팅 기능을 만들 수 없을까?

결론은 웹 소켓만으로 채팅을 만드는 것은 가능하다. 하지만 왜 Stomp와 비교해서 기술을 선택했을까?

### Stomp

웹 소켓 프로토콜은 **두 가지(텍스트, 바이너리) 유형의 메시지**를 정의하고 있지만 메시지의 내용까지는 정의하고 있지 않는다.

**Somp**는 **메시지 전송을 효율적으로 하기 위해 등장한 프로토콜**이다. 기본적으로 **pub/sub 구조**를 따르고 있기 때문에 메시지를 전송하고 메시지를 받아 처리하는 부분이 명확하다는 장점이 있다.

Somp를 사용해 채팅 시스템을 개발한다고 한다면 크게 2가지 행동이 있다고 볼 수 있다.

- 채팅방 입장: 현재 입장한 채팅방 번호를 구독한다.
- 채팅방에서 메시지를 보내거나 받기: 구독한 채팅방에서 메시지를 보내거나 받아볼 수 있다.

**Somp를 시용하면 좋은 점**

- 채팅 엔드포인트를 Spring Security를 이용하여 권한을 제어할 수 있다.
    - ex) 운영자만 입장 가능한 채팅방
- Publisher으로 부터 전달 받은 메시지를 Subscriber로 전달해줄 때 중간에서 메시지를 주고 받게 해주는 메시지 브로커를 사용할 수 있다.

Stomp를 사용하면 기본적으로 **In-Memory Message Broker**를 사용하게 되는데, 이로인해 생기는 여러가지 문제가 있다. 하지만 이 부분은 은 **RabbitMQ, Kafka, Active MQ와 같은 외부 브로커를 사용함으로서 문제를 해결**할 수 있다고 한다.

### 결론

현재 구현해야 하는 기능은 채팅 기능이다.

채팅을 초점에 두고 생각을 해보면, **WebSocket**은 어떤 채팅방에 현재 누가 접속중인지 알아야하고, 채팅방에 포함된 사용자에게 모두 메시지를 보내야 하기 때문에 **채팅마다 세션을 관리**해야하는 번거로움이 있다.

Stomp는 **사용자가 채팅방에 접속했을 때 해당 채팅방을 구독**하기만 한다면 누가 접속중인지 따로 관리하지 않아도 **메시지를 보낸 사용자가 포함된 채팅방의 모든 사람에게 메시지**가 갈 수 있다는 강점을 가지고 있다.

이러한 부분에서 채팅 기능에 좀 더 부합한 기술은 **Stomp**라고 판단하여 채택하게 되었다.
